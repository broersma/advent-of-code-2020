use std::str::FromStr;
use regex::Regex;
use ::function_name::named;

#[derive(Debug, PartialEq)]
struct InputLine {
    min: usize,
    max: usize,
    letter: String,
    password: String,
}

impl FromStr for InputLine {
    type Err = String;

    fn from_str(policy_password_str: &str) -> Result<Self,Self::Err> {
        let re = Regex::new(
            r"(\d+)\-(\d+) ([a-z]): ([a-z]+)",
        ).unwrap();
    
        re.captures(policy_password_str).and_then(|cap| {
            Some(InputLine {
                min: cap.get(1).unwrap().as_str().parse::<usize>().unwrap(),
                max: cap.get(2).unwrap().as_str().parse::<usize>().unwrap(),
                letter: cap.get(3).unwrap().as_str().to_string(),
                password: cap.get(4).unwrap().as_str().to_string()
            })
        }).ok_or("Not good.".to_string())
    }
}

#[named]
fn part1(input : &Vec<String>) {
    let delta = (3,1);
    let mut pos = delta;
    let mut tree_count = 0;
    while pos.1 < input.len() {        
        let xpos = pos.0 % input.get(pos.1).unwrap().chars().count();
        if input.get(pos.1).unwrap().chars().nth(xpos) == Some('#') {
            tree_count += 1;
        }

        pos.0 += delta.0;
        pos.1 += delta.1;
    }    
    println!("{}::{} {:?}", module_path!(), function_name!(), tree_count);
}

#[named]
fn part2(input : &Vec<String>) {
    let deltas = vec![(1,1), (3,1), (5,1), (7,1), (1,2)];

    let mut multiplied_tree_count: u32 = 1;
    for delta in deltas {
        let mut pos = delta;
        let mut tree_count = 0;
        while pos.1 < input.len() {        
            let xpos = pos.0 % input.get(pos.1).unwrap().chars().count();
            if input.get(pos.1).unwrap().chars().nth(xpos) == Some('#') {
                tree_count += 1;
            }

            pos.0 += delta.0;
            pos.1 += delta.1;
        }
        multiplied_tree_count *= tree_count;
    }
    println!("{}::{} {:?}", module_path!(), function_name!(), multiplied_tree_count);
}

#[test]
fn main() {
    let input: Vec<String> = ".#..#....##...#....#.....#.#...
    ........##....#..#..##....#.#..
    ......##......##.........#....#
    ...#.....#....##.......#.#....#
    .#.###.#.#..#.....##..#....#.#.
    ##.........##.....####......#..
    #...#..........#.##............
    ####............#..........#.#.
    ......#......#....##...#..##...
    #..#....#...#......#......####.
    ......#..........#.........#.#.
    ...##.......#..#.#..#..#....#..
    ..####....#.#...............##.
    ...###........#.....#..........
    #..#.##...##.#..##...##...#....
    .###........#.##..#.#.....#....
    .#.......#..##.......#......#..
    .##...........#..............#.
    ...#..#.....#...........#...#..
    .....#..............#..#.......
    .......#....#.....##...........
    .#...#.............#.....##....
    ....#.#....#...#...#..#..##.#..
    ...#..##..##...#..##........#.#
    .###..#...#.#.#.#..#...#.......
    .....##.#.##.#.#.......#..#....
    .##.#...#.....#...#....#.....#.
    .....#......###....###..##.#..#
    .....#..##....#..#.#..#.#.#....
    #....#.....#.#.......#...#....#
    ...#........#............#..#..
    #.#...#...#..##.........#...##.
    .#..#.#...........#....#...#...
    ##..#.#..........#.....###...#.
    #..#........#.......#.#..#....#
    ..#...##....#..#....#....#.....
    ...#.....##....#...#..#....##.#
    .....#......#...#.#.#.#.#......
    ###.....#..#.#..........##.#...
    ...............#..#...#.#....#.
    #.....#.....###....#..........#
    ........#...#.#.......#..#...#.
    ..#.##...#...#...#.........#...
    #..........#..#.#...........##.
    ##.......#.#.#...#.....#.......
    ...#.#.#.....#......#....##..#.
    ##.#.....#....#...#.......#....
    .#......##..#.##.#....##..##.#.
    ..#..#......#....#...#..#.#....
    ...#..###...#.......#..#.......
    ...#....#..#....#........##....
    #...#...#....#.#.........###.#.
    .#.........##..##...#..........
    ...##.....##.........#..#..#...
    ###....#......#.##..#...#......
    .###....#.#.......#..#....#...#
    ....####........##....#.#....##
    ..#.....#......##...#..#..#....
    ...#....#...#......#.###.#.#.#.
    ......#.......#..#...#...#.....
    .#...#...#..#.#..........#.....
    ........#..#.........#.#....##.
    .#....#.......#........#.##.#..
    ...#...#..#.....#......#...##..
    .#.................#........###
    .......#.#..#.#...#............
    .#.......#..##...#.###....#.##.
    #........#.###.#..#........##..
    ..##.#....##......##........#..
    ...............#...............
    #.......#......##..#.#....#.#.#
    ..#.....#......#.#.#...#...##..
    ..........#........#.....##...#
    #..........#.#..#..##..#......#
    .......#..###..##.#..##........
    #.#..##..###..#.###.....#.#..##
    ..#.#........#...###...##......
    .......##.....##...#.##........
    .#.#...###..#..#......##....##.
    #...#.#.....##..#..#..#.#....#.
    ........#......#....#..#.......
    ...#.#.#.#........###....#...#.
    .#......#...#.......#......#...
    #...#.##.#..#.#..#.........#...
    ....#......##......#........#.#
    ..##.#.....#..#......#..#......
    #.##...##...#................#.
    .....#..#....#....#####........
    ....#..#..#.#...#.#............
    .........#.#....#..#....##...#.
    #....#..........#......#......#
    .......#..............#......#.
    .#..#...#..#.#.....#.#.#.##.#..
    .##........#......#...#.##.....
    ...#.##..#........#...........#
    ..#...#..#........#.......#.#..
    #.....#..#.#..#..#...#...#..#..
    ..................#.#.....#...#
    ........#...##.#..#.........#..
    .#...##.#...........##.##...#..
    #......#.........#...#...#...#.
    ..........#.............#...#..
    #............##.#..#...#.#...#.
    ..#.##...##....##.#...####...#.
    #.##..#......#.......#.#...##..
    .....#...#..#......#####.##..#.
    #...#.#.##..#..##.....#......#.
    .#..#......#.#.#...#.#...##.#..
    .#.....#..##........#.....#...#
    .................#..........#..
    ##.#.#......#.####..#.....#....
    .#...##.####..#...#............
    ..#...............###....#....#
    #...#..###..#.#.##...........##
    ...................#..#.....#..
    ...#.##.#...#.....#......#.##..
    #.#...#.........##.#........#.#
    .##.......#..#..#.....##....#..
    ......##.#.#..#...#.#..##.....#
    ..#..###...#...#......#.#......
    ..##....#.#...#....#....#..#..#
    #..##....#........#..##..#..#.#
    .......#............#....##..#.
    .#.#..#.........#.#.##......#..
    #.#....#..##..#..###.#.....##..
    .###.#......#.....#####...#....
    #...#.#...##......#...#.#...##.
    #..#.........#..#............#.
    ...##......##.......##....##...
    ...#...##....###..###.#...#....
    #.#....#...#.#...##..#........#
    .#..#..................#....#..
    #......#..#...##..##...#..##..#
    ...#..#.....#...#........#.#.#.
    #...#..##....#.....#........#..
    .##..#....#.....#.#............
    ##..##.#.#.##.#.#..#.#..#....#.
    #.......#...............#.....#
    ..#.....#..##.....#...##.##....
    ...#..#...#.#.#....#......#....
    ###.#.......#....#....#.#...#..
    .....###..#...###.#.#..#.......
    .....#.........##.#....#..##.#.
    ........#....#....#....#.#..##.
    ........###....#.#.........#.#.
    .#..###..#........#.......##.#.
    .#.#...........................
    ..#....##...#.#....#....#.#....
    .#...#...##.#........###....#..
    #.#....#...#.#.#...##......##..
    #......#....#...#..#....#...#..
    ...#..##........#.#...##......#
    ....##...........##...#..#..#..
    ......#..#........#..#....##.##
    .###..#.#.........#.....#......
    .#..##............#......#.....
    ..##.#.#..#..#.###....#..#..#..
    ....#.#..#.#..##...##.#.#.#.#..
    ....#..#....#...............#..
    ..#...#.##.....##....#..##..#..
    .......##.#....#.##....#.......
    .#...#........#...#......#.###.
    ..#....##.......#....#.#...#.#.
    .....#.....#...##..#....#.#..##
    ..##........##............##...
    ..........#...#.......#.......#
    .#...............#...#.##......
    #.##......#....#.##.#..#..#...#
    ......###.........#...#..#....#
    ....#......#...#....#....#...#.
    #...##...#....#......####....#.
    .................#......#......
    ..#..........##.......##..#.##.
    .#.....#.......#...######..#..#
    ....##.#...#...#..........#....
    .....#.......#...#.#.......###.
    #...#.###.....#...#.......#....
    .#.##.####....#.....#.#........
    .......#.....##............##..
    ..#...#.#.##........#...##...#.
    ........#...####.##..#....#...#
    #.......#...##.#......#..#...#.
    ......#.........#..###.#.#....#
    #..##...#...#..#...#...#.....#.
    .#...#...#.#.................##
    #......#.....#..#.#..#......##.
    .......#.##...#.......#.......#
    .#.#..#..#......#....#.#...#.#.
    ..#...#.#..#......#...#.#.#....
    ........#..............#..##...
    .##..#..##.#....#.#..###..#..#.
    ..#....#......#...#.#.#....#...
    ...#..#..#....#..#.....##......
    .#......#...#........##........
    .#......#..#...##..#..#.#.#....
    .##......#.##.........#....#...
    ....#....##..#..###.#..#......#
    ....#....##..........#.#...#...
    ..##.#.............#..#.....#..
    ..#.....#....#....#.......##...
    .##.#....#....#...#....##.#....
    ...#.#..#.###.#..#.#.......#.#.
    .....##.....#.......#......#...
    .#.....#..#.#.#..#........##...
    ##.....................#.......
    ..###............#........##..#
    .#.##.....#..#..#..#.#.......#.
    .##...................#..#..#..
    ..#.#...#..........##..#..##...
    #......#..#..#.#..#......#..#.#
    .#...#....#.#.........#.....#.#
    #..........#.#....#....#.#.#.#.
    #.....#..........#..#....#..#..
    ........#....#..##.#.#.......#.
    .#.......##.......#..##...#....
    ...#..##..#......##.#..#.#..#..
    .#..#.......#..##..#......#....
    ###.#.........#......#.#.......
    ...#......#....#..##..#.#..#...
    ......#..#.....#.........#....#
    ....#..#..#..#.........##.#..#.
    ......#..#..#..#....#...#..##.#
    ......##.#..#..#.#.......#.#.##
    ..#.....#...#..#....#..........
    .##..##.....##.......#.##.#....
    ...#..#.......#..#.......#.....
    .........#....##..#.#....#.#...
    .....#..#...#.........#....#..#
    .........##.....#.#...#.###...#
    .#......####..##...#..#........
    .#......##....#.....#..........
    ##.......##.#.......#..........
    .#......#.#.#.#....#........#..
    ......##..##...#...#...........
    .#...#.#..#......#.#.#.#....#.#
    ...#.........#.....#...###.....
    #.....##....#.##...#....#......
    .#..#...#..##.###.#.#.#...#....
    ...#......#..#....#...#...#....
    .#..............#.....#........
    ..##...#.....#..#.....#..#.#...
    .##...#....#.##...#.........##.
    ..#......#...##..#.....#......#
    #.#..............#...#...#..#.#
    ..#..#.#...........#...#.#.#...
    #..........#...#..#..##..#....#
    ............#...#........###...
    .........#.....#.....#..#......
    #...#.#..##......#.#####.......
    ...#........#..............#...
    ......###.#.#.....#..#....##.#.
    .#.#.#..##....###.#..#....##...
    .#....#.##............##.#.....
    ##...##.#......#.#.##.##...###.
    .......#.#........#.....#......
    ....#.....#......#...#.#..#....
    .#.........#....#...#...#...#.#
    #.......#................#..#..
    .##...........#.##...##....#...
    #...#.#...###.........#.......#
    .#...#.........................
    #.......#...#.....##.##...##...
    .#.#....#.......#.#.##.#....#..
    #..#....#...#.#.##.#....#....#.
    .##.....#.#..#...#..#..........
    .............#...#.#..#........
    ....#........#..#......##......
    #.....#....#.....#.......#.....
    ........#.......##....#........
    .#.#..##.......................
    ##..#.....#........#.....#.....
    .#......#.#...#.#..........#..#
    .#..#.....#..#..........#.###..
    ......#.#..#.#.......#.#.....#.
    .#....#......#..##.............
    #...##.........#.#.#...#.....#.
    ..#................#..#..###...
    #.....#....##.#..##......#.#.#.
    ..#....#...#...#...............
    #................#....#...#.#..
    ................#...#.....#.##.
    ..#.#.#..#.##.......##.......##
    ...........#......##.......###.
    ...#.......##.........#.#.#.#..
    .#...#.#..#...#.#.....#........
    ............#####......##......
    ....###....#.##...#..#.........
    ..#.#...#.......#...#...#.###..
    ..............##..#...#....#...
    #.#..##...#....##.........#....
    ..#...#.....#...........#...#..
    #.#..###..#.#..#........#..#.#.
    ...###...##...#...#.#.........#
    ..#........#.....#.#.#.......#.
    ...#..#..........#.....#...#...
    ....#..#.....#....##....#.##...
    .....##..#...#.#..##...#...##.#
    ...........###...##....#.......
    ##..#.#..#..#...#....##..#..#..
    ##...#.#......##.#..#...#....#.
    .#.......#...........#...#.....
    #...#....#.......#...#.##......
    .........#.......#...#.#...#...
    .......##.#..................#.
    ........#..#.#......#.....#....
    .....#.#.#.#....##...#.###.....
    #.#.........#..#.#.#.#.#.......
    .............#....#.......###..
    .#.##....#....##.........####..
    ...........###.#...............
    #.........##.#.#..#.....##.###.
    .#.#.....#.#...#.....##...#...#
    #....#...#.........#.#.......#.
    .....#.###..#....#...##..#...#.
    #........#....#.#..#....#.#....
    #.#..##......#.........#.#.....
    ##..#.....#......###....#....#.
    #.#.####..#.#.#......##...#..#.
    ....#.....#.#.#.#.....#........
    ..##..........#......#.#.#..#..
    .#...##.##.........#.........##
    ..#.#.#..........#..#..#......#
    ###..###..#...#................".split("\n").map(|x| x.trim().to_string()).collect();

    part1(&input);
    part2(&input);
}
